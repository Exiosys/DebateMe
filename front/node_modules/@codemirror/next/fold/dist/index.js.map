{"version":3,"file":"index.js","sources":["../src/fold.ts"],"sourcesContent":["import {combineConfig, fillConfig, EditorState, Annotation, Facet, StateField} from \"../../state\"\nimport {EditorView, BlockInfo, Command, Decoration, DecorationSet, WidgetType, themeClass} from \"../../view\"\nimport {gutter, GutterMarker} from \"../../gutter\"\n\ntype Range = {from: number, to: number}\n\nconst foldAnnotation = Annotation.define<{fold?: readonly Range[],\n                                          unfold?: readonly Range[]}>()\n\nfunction selectedLines(view: EditorView) {\n  let lines: BlockInfo[] = []\n  for (let {head} of view.state.selection.ranges) {\n    if (lines.some(l => l.from <= head && l.to >= head)) continue\n    lines.push(view.lineAt(head))\n  }\n  return lines\n}\n\nconst foldState = StateField.define<DecorationSet>({\n  create() {\n    return Decoration.none\n  },\n  update(folded, tr) {\n    folded = folded.map(tr.changes)\n    let ann = tr.annotation(foldAnnotation)\n    if (ann) {\n      let {fold = [], unfold = []} = ann\n      if (unfold.length || fold.length)\n        folded = folded.update({\n          add: fold.map(({from, to}) => FoldWidget.decoration.range(from, to)),\n          filter: (from, to) => !unfold.some(r => r.from == from && r.to == to),\n          filterFrom: unfold.reduce((m, r) => Math.min(m, r.from), 1e8),\n          filterTo: unfold.reduce((m, r) => Math.max(m, r.to), 0)\n        })\n    }\n    return folded\n  }\n}).provide(EditorView.decorations)\n\nfunction foldInside(state: EditorState, from: number, to: number) {\n  let found: {from: number, to: number} | null = null\n  state.field(foldState, false)?.between(from, to, (from, to) => {\n    if (!found || found.from > from) found = ({from, to})\n  })\n  return found\n}\n\nexport const foldCode: Command = view => {\n  if (!view.state.field(foldState, false)) return false\n  let fold = []\n  for (let line of selectedLines(view)) {\n    let range = view.state.facet(EditorState.foldable)\n      .reduce<Range | null>((value, f) => value || f(view.state, line.from, line.to), null)\n    if (range) fold.push(range)\n  }\n  if (!fold.length) return false\n  view.dispatch(view.state.t().annotate(foldAnnotation, {fold}))\n  return true\n}\n\nexport const unfoldCode: Command = view => {\n  if (!view.state.field(foldState, false)) return false\n  let unfold: Range[] = []\n  for (let line of selectedLines(view)) {\n    let folded = foldInside(view.state, line.from, line.to)\n    if (folded) unfold.push(folded)\n  }\n  if (!unfold.length) return false\n  view.dispatch(view.state.t().annotate(foldAnnotation, {unfold}))\n  return true\n}\n\nexport interface FoldConfig {\n  placeholderDOM?: (() => HTMLElement) | null,\n  placeholderText?: string\n}\n\nconst defaultConfig: Required<FoldConfig> = {\n  placeholderDOM: null,\n  placeholderText: \"…\"\n}\n\nconst foldConfig = Facet.define<FoldConfig, Required<FoldConfig>>({\n  combine(values) { return combineConfig(values, defaultConfig) }\n})\n\nexport function codeFolding(config: FoldConfig = {}) {\n  return [\n    foldConfig.of(config),\n    foldState,\n    baseTheme\n  ]\n}\n\nclass FoldWidget extends WidgetType<null> {\n  ignoreEvents() { return false }\n\n  toDOM(view: EditorView) {\n    let conf = view.state.facet(foldConfig)\n    if (conf.placeholderDOM) return conf.placeholderDOM()\n    let element = document.createElement(\"span\")\n    element.textContent = conf.placeholderText\n    // FIXME should this have a role? does it make sense to allow focusing by keyboard?\n    element.setAttribute(\"aria-label\", view.phrase(\"folded code\"))\n    element.title = view.phrase(\"unfold\")\n    element.className = themeClass(\"foldPlaceholder\")\n\n    element.onclick = event => {\n      let line = view.lineAt(view.posAtDOM(event.target as HTMLElement))\n      let folded = foldInside(view.state, line.from, line.to)\n      if (folded) view.dispatch(view.state.t().annotate(foldAnnotation, {unfold: [folded]}))\n      event.preventDefault()\n    }\n    return element\n  }\n\n  static decoration = Decoration.replace({widget: new FoldWidget(null)})\n}\n\nexport interface FoldGutterConfig {\n  openText?: string\n  closedText?: string\n}\n\nconst foldGutterDefaults: Required<FoldGutterConfig> = {\n  openText: \"⌄\",\n  closedText: \"›\"\n}\n\nclass FoldMarker extends GutterMarker {\n  constructor(readonly config: Required<FoldGutterConfig>,\n              readonly open: boolean) { super() }\n\n  eq(other: FoldMarker) { return this.config == other.config && this.open == other.open }\n\n  toDOM(view: EditorView) {\n    let span = document.createElement(\"span\")\n    span.textContent = this.open ? this.config.openText : this.config.closedText\n    span.title = view.phrase(this.open ? \"Fold line\" : \"Unfold line\")\n    return span\n  }\n}\n\nexport function foldGutter(config: FoldGutterConfig = {}) {\n  let fullConfig = fillConfig(config, foldGutterDefaults)\n  return [\n    gutter({\n      style: \"foldGutter\",\n      lineMarker(view, line) {\n        // FIXME optimize this. At least don't run it for updates that\n        // don't change anything relevant\n        let folded = foldInside(view.state, line.from, line.to)\n        if (folded) return new FoldMarker(fullConfig, false)\n        if (view.state.facet(EditorState.foldable).some(f => f(view.state, line.from, line.to)))\n          return new FoldMarker(fullConfig, true)\n        return null\n      },\n      initialSpacer() {\n        return new FoldMarker(fullConfig, false)\n      },\n      domEventHandlers: {\n        click: (view, line) => {\n          let folded = foldInside(view.state, line.from, line.to)\n          if (folded) {\n            view.dispatch(view.state.t().annotate(foldAnnotation, {unfold: [folded]}))\n            return true\n          }\n          let range = view.state.facet(EditorState.foldable)\n            .reduce<Range | null>((value, f) => value || f(view.state, line.from, line.to), null)\n          if (range) {\n            view.dispatch(view.state.t().annotate(foldAnnotation, {fold: [range]}))\n            return true\n          }\n          return false\n        }\n      }\n    }),\n    codeFolding()\n  ]\n}\n\nconst baseTheme = EditorView.baseTheme({\n  foldPlaceholder: {\n    background: \"#eee\",\n    border: \"1px solid silver\",\n    color: \"#888\",\n    borderRadius: \".2em\",\n    margin: \"0 1px\",\n    padding: \"0 1px\",\n    cursor: \"pointer\"\n  },\n\n  \"gutterElement.foldGutter\": {\n    padding: \"0 1px\",\n    cursor: \"pointer\"\n  }\n})\n"],"names":["Annotation","StateField","Decoration","EditorView","EditorState","Facet","combineConfig","WidgetType","view","themeClass","GutterMarker","fillConfig","gutter"],"mappings":"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"}
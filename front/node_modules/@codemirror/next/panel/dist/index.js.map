{"version":3,"file":"index.js","sources":["../src/panel.ts"],"sourcesContent":["import {EditorView, ViewPlugin, PluginField, ViewUpdate, themeClass} from \"../../view\"\nimport {Facet, Extension} from \"../../state\"\n\n/// Enables the panel-managing extension.\nexport function panels(): Extension { return [panelPlugin, baseTheme] }\n\n/// Object that describes an active panel.\nexport interface Panel {\n  /// The element representing this panel.\n  dom: HTMLElement,\n  /// Optionally called after the panel has been added to the editor.\n  mount?(): void\n  /// Update the DOM for a given view update.\n  update?(update: ViewUpdate): void\n  /// An optional theme selector. By default, panels are themed as\n  /// `\"panel\"`. If you pass `\"foo\"` here, your panel is themed as\n  /// `\"panel.foo\"`.\n  style?: string,\n  /// Whether the panel should be at the top or bottom of the editor.\n  /// Defaults to false.\n  top?: boolean\n  /// An optional number that is used to determine the ordering when\n  /// there are multiple panels. Those with a lower `pos` value will\n  /// come first. Defaults to 0.\n  pos?: number\n}\n\n/// Opening a panel is done by providing an object describing the\n/// panel through this facet.\nexport const showPanel = Facet.define<(view: EditorView) => Panel>()\n\nconst panelPlugin = ViewPlugin.fromClass(class {\n  specs: readonly ((view: EditorView) => Panel)[]\n  panels: Panel[]\n  top: PanelGroup\n  bottom: PanelGroup\n\n  constructor(view: EditorView) {\n    this.specs = view.state.facet(showPanel)\n    this.panels = this.specs.map(spec => spec(view))\n    this.top = new PanelGroup(view, true, this.panels.filter(p => p.top)) \n    this.bottom = new PanelGroup(view, false, this.panels.filter(p => !p.top))\n    for (let p of this.panels) {\n      p.dom.className += \" \" + panelClass(p)\n      if (p.mount) p.mount()\n    }\n  }\n\n  update(update: ViewUpdate) {\n    let specs = update.state.facet(showPanel)\n    if (specs != this.specs) {\n      let panels = [], top: Panel[] = [], bottom: Panel[] = [], mount = []\n      for (let spec of specs) {\n        let known = this.specs.indexOf(spec), panel\n        if (known < 0) {\n          panel = spec(update.view)\n          mount.push(panel)\n        } else {\n          panel = this.panels[known]\n          if (panel.update) panel.update(update)\n        }\n        panels.push(panel)\n        ;(panel.top ? top : bottom).push(panel)\n      }\n      this.specs = specs\n      this.panels = panels\n      this.top.sync(top)\n      this.bottom.sync(bottom)\n      for (let p of mount) {\n        p.dom.className += \" \" + panelClass(p)\n        if (p.mount) p.mount!()\n      }\n    } else {\n      for (let p of this.panels) if (p.update) p.update(update)\n    }\n  }\n}).provide(PluginField.scrollMargins, value => ({top: value.top.scrollMargin(), bottom: value.bottom.scrollMargin()}))\n\nfunction panelClass(panel: Panel) {\n  return themeClass(panel.style ? `panel.${panel.style}` : \"panel\")\n}\n\nclass PanelGroup {\n  dom: HTMLElement | null = null\n\n  constructor(readonly view: EditorView, readonly top: boolean, public panels: Panel[]) {\n    this.syncDOM()\n  }\n\n  sync(panels: Panel[]) {\n    this.panels = panels\n    this.syncDOM()\n  }\n\n  syncDOM() {\n    if (this.panels.length == 0) {\n      if (this.dom) {\n        this.dom.remove()\n        this.dom = null\n      }\n      return\n    }\n\n    if (!this.dom) {\n      this.dom = document.createElement(\"div\")\n      this.dom.className = themeClass(this.top ? \"panels.top\" : \"panels.bottom\")\n      this.dom.style[this.top ? \"top\" : \"bottom\"] = \"0\"\n      this.view.dom.insertBefore(this.dom, this.top ? this.view.dom.firstChild : null)\n    }\n\n    let curDOM = this.dom.firstChild\n    for (let panel of this.panels) {\n      if (panel.dom.parentNode == this.dom) {\n        while (curDOM != panel.dom) curDOM = rm(curDOM!)\n        curDOM = curDOM!.nextSibling\n      } else {\n        this.dom.insertBefore(panel.dom, curDOM)\n      }\n    }\n    while (curDOM) curDOM = rm(curDOM)\n  }\n\n  scrollMargin() {\n    return !this.dom ? 0 : Math.max(0, this.top\n                                    ? this.dom.getBoundingClientRect().bottom - this.view.scrollDOM.getBoundingClientRect().top\n                                    : this.view.scrollDOM.getBoundingClientRect().bottom - this.dom.getBoundingClientRect().top)\n  }\n}\n\nfunction rm(node: ChildNode) {\n  let next = node.nextSibling\n  node.remove()\n  return next\n}\n\nconst baseTheme = EditorView.baseTheme({\n  panels: {\n    background: \"#f5f5f5\",\n    boxSizing: \"border-box\",\n    position: \"sticky\",\n    left: 0,\n    right: 0\n  },\n  \"panels.top\": {\n    borderBottom: \"1px solid silver\"\n  },\n  \"panels.bottom\": {\n    borderTop: \"1px solid silver\"\n  }\n})\n"],"names":["Facet","ViewPlugin","PluginField","themeClass","EditorView"],"mappings":"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"}